# POSIX Refactor TODO

## Session Focus (do these first)
- [x] Strip animation, frame parsing, and all `popen` usage from `minifetch.c`; leave only core collectors we plan to keep.
- [x] Downgrade the C code to strict C89: move declarations to block tops, replace `//` comments, remove `stdbool.h` in favor of a compat typedef.
- [x] Check that the current build succeeds with `cc -std=c89 -Wall -Wextra -Werror -pedantic -D_POSIX_C_SOURCE=200809L`.

## CI recovery plan
- [x] Restore executable permissions on helper scripts (`tools/embed_logo.sh`, `tests/smoke.sh`) so `make`/`./tests/smoke.sh` work on CI runners.
- [x] Update `CMakeLists.txt` logo embed rule to invoke the shell script (not `python3`), then regen `build/logo_data.c` via `cmake --build`.
- [x] Make `tests/smoke.sh` strictly POSIX (`ANSI_ESC` via `printf`, avoid Bash-only constructs) and re-run `shellcheck` locally.
- [x] Call helper scripts via `sh` (`Makefile`, CMake, CI) so CI is resilient to missing execute bits.
- [ ] Run the full CI matrix locally: `make`, `make minifetch-linux`, `tests/smoke.sh`, `cmake -S . -B build`, `cmake --build build`, `ctest --test-dir build --output-on-failure` under both gcc and clang.
- [x] Ensure `tests/smoke.sh` passes when executed with `/bin/sh` (dash) after the fixes.

## Repo Restructure
- [x] Split sources under `src/` (`main.c`, `core.c`, `linux_extras.c`, `term.c`, `cli.c`, `compat.c`) and expose public headers under `include/`.
- [x] Delete legacy assets (`frames/`, `logo_embedded.inc`, embed scripts) after confirming no references remain.
- [x] Introduce a simple Makefile (or shell script) that builds the core target plus an optional Linux extension variant with `-D_MINIFETCH_LINUX_EXT=1`.

## Feature Parity & Behaviour
- [x] Reimplement core collectors (uname, statvfs, sysconf, $SHELL) with bounded helpers; enforce color output only when stdout is a TTY.
- [x] Add Linux-only collectors guarded behind `#ifdef __linux__` (os-release, `/proc/meminfo`, `/proc/uptime`) returning graceful failure codes.
- [x] Replace option parsing with POSIX `getopt`: `-a` (all fields), `-c` (no color), `-q` (quiet), `-h` (help).

## Quality Bar
- [x] Provide `tests/smoke.sh` that exercises TTY vs piped output and validates Linux extras when enabled.
- [ ] Run builds on at least one glibc and one BSD/musl environment; record results in the PR.
- [x] Update docs (`README.md`, new `PORTABILITY.md`, `CONTRIBUTING.md`) once code changes stabilize.

## Definition of Done
- [ ] Core build is warning-free under C89 across Linux/BSD/macOS.
- [ ] Linux extras compile and run only on Linux; non-Linux still succeeds with core feature set.
- [x] No stray references to animation, JSON, GPU/resolution, or external pipelines remain.

- [x] Restore a monotonic timebase inside `mf_run_hidden_mode`: keep `start_time` (or accumulate a running phase) and feed `z = (now - start_time) * MF_HIDDEN_SPEED`. The current `elapsed` computation uses the frame delta so the noise field barely changes, which breaks the background animation pacing.
- [x] Rework `mf_hidden_overlay_buffer` to operate on display columns rather than raw byte counts:
    - Build logo width from `mf_utf8_display_width` instead of `strlen`,
    - When copying the logo and formatted info lines into the overlay buffer, advance the terminal column using glyph width while writing the corresponding byte sequence, so multi-byte glyphs (logo blocks, ANSI escapes) do not blow past the reserved border.
- [x] When computing the bordered box dimensions, base `inner_width` on the actual display width of logo/info (not `strlen`). This keeps the 1-char empty margin consistent even with coloured output or wide glyphs.
- [x] Ensure the diff renderer warms the screen once after resizing: after clearing, copy `curr` into `prev` so the first present emits the full frame (avoids leftover gradient stripes when the buffers resize).
- [x] After adjusting the scroll region (`CSI set top/bottom`), immediately move the cursor back to the home position before drawing; repeat this whenever the terminal is resized so the HUD line stays pinned.
